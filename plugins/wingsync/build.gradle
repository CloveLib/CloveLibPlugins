// WingSync - Discord whitelist sync plugin
// Read version from VERSION file
def versionFile = file('VERSION')
if (versionFile.exists()) {
    version = versionFile.text.trim()
} else {
    version = '5.0.0'  // fallback
}
description = "Discord bot integration for whitelist management"

dependencies {
    // Depends on CloveLib
    compileOnly project(':clovelibapi')

    // JDA for Discord bot (will pull in all transitive dependencies)
    implementation 'net.dv8tion:JDA:6.2.1'

    // Gson for JSON storage
    implementation 'com.google.code.gson:gson:2.13.2'
}

// Fix: Explicitly declare the dependency on clovelib:shadowJar
tasks.named('compileJava') {
    dependsOn ':clovelibapi:shadowJar'
}

shadowJar {
    archiveBaseName.set('WingSync')

    // Relocate JDA and its dependencies to avoid conflicts
    relocate 'net.dv8tion', 'win.clovelib.libs.jda'
    relocate 'com.neovisionaries', 'win.clovelib.libs.neovisionaries'
    relocate 'okhttp3', 'win.clovelib.libs.okhttp3'
    relocate 'okio', 'win.clovelib.libs.okio'
    relocate 'gnu.trove', 'win.clovelib.libs.trove'
    relocate 'com.fasterxml.jackson', 'win.clovelib.libs.jackson'
    relocate 'org.apache.commons', 'win.clovelib.libs.commons'
    relocate 'kotlin', 'win.clovelib.libs.kotlin'
    relocate 'org.jetbrains', 'win.clovelib.libs.jetbrains'
    relocate 'org.intellij', 'win.clovelib.libs.intellij'
    relocate 'org.slf4j', 'win.clovelib.libs.slf4j'

    // Merge service files (important for OkHttp/Okio)
    mergeServiceFiles()

    // Include ALL runtime dependencies (this is the key change)
    configurations = [project.configurations.runtimeClasspath]

    // Exclude unnecessary files to reduce JAR size
    exclude 'META-INF/*.SF'
    exclude 'META-INF/*.DSA'
    exclude 'META-INF/*.RSA'
    exclude 'META-INF/MANIFEST.MF'
    exclude 'META-INF/maven/**'
    exclude 'META-INF/versions/**'
}
